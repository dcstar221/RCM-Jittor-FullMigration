# RCM-Fusion PyTorch â†’ Jittor è¿ç§»è¿›åº¦åˆ†ææŠ¥å‘Š

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

**RCM-Fusion**Â (Radar-Camera Multi-Level Fusion for 3D Object Detection) æ˜¯ä¸€ä¸ªåŸºäº PyTorch/MMDet3D çš„ 3D ç›®æ ‡æ£€æµ‹æ¨¡å‹ï¼Œæœ¬é¡¹ç›®æ—¨åœ¨å°†å…¶å®Œæ•´è¿ç§»åˆ°Â **Jittor (è®¡å›¾)**Â æ¡†æ¶ã€‚åŸå§‹é¡¹ç›®æ·±åº¦ä¾èµ–Â `mmcv`ã€`mmdet`ã€`mmdet3d`Â ç”Ÿæ€ç³»ç»Ÿä»¥åŠ CUDA ä¸“ç”¨ç®—å­ (SpConvã€Deformable Attention)ã€‚

---

## âœ… å·²å®Œæˆçš„å†…å®¹

### 1. åŸºç¡€è®¾æ–½å±‚ (Infrastructure)

| æ¨¡å—                | æ–‡ä»¶                       | çŠ¶æ€    | è¯´æ˜                                                                                                                                                 |
| ----------------- | ------------------------ | ----- | -------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Jittor é€‚é…å±‚**    | jittor_adapter.pyÂ (465è¡Œ) | âœ… å·²å®Œæˆ | å®Œæ•´å®ç°äº†Â <br><br>Registryã€<br><br>Configã€<br><br>BaseModuleã€<br><br>FFNã€<br><br>MultiheadAttentionã€<br><br>SinePositionalEncodingï¼Œä»¥åŠæ‰€æœ‰Â `build_*`Â å·¥å‚å‡½æ•° |
| **æ ‡å‡†æ³¨å†Œè¡¨**         | åŒä¸Š                       | âœ… å·²å®Œæˆ | `DETECTORS`ã€`BACKBONES`ã€`HEADS`ã€`NECKS`ã€`ATTENTION`Â ç­‰ 15+ æ³¨å†Œè¡¨                                                                                      |
| **ç¯å¢ƒè‡ªåŠ¨åŒ–**         | `setup_migration.py`     | âœ… å·²å®Œæˆ | è‡ªåŠ¨æ£€æµ‹ç¼–è¯‘å™¨ã€ä¿®è¡¥ Jittor æºç  bugã€ç”Ÿæˆç¯å¢ƒå˜é‡                                                                                                                    |
| **ä¿®æ”¹çš„ Jittor æºç ** | `jittor/`Â ç›®å½• (510ä¸ªå­é¡¹)    | âœ… å·²å®Œæˆ | åŒ…å«ç¼–è¯‘å™¨è¡¥ä¸ç­‰ä¿®æ”¹                                                                                                                                         |

### 2. æ¨¡å‹æ ¸å¿ƒç»„ä»¶ (Model Components)

| æ¨¡å—                              | åŸå§‹ (PyTorch)                   | Jittor ç§»æ¤æ–‡ä»¶                                                      | çŠ¶æ€    |
| ------------------------------- | ------------------------------ | ---------------------------------------------------------------- | ----- |
| **Radar Backbone**              | `spconv_backbone.py`Â (3D ç¨€ç–å·ç§¯) | spconv_backbone_2d.pyÂ (392è¡Œ)                                     | âœ… å·²å®Œæˆ |
| **Image Backbone**              | ResNet                         | resnet_jittor.py                                                 | âœ… å·²å®Œæˆ |
| **Neck (FPN)**                  | second_fpn.py                  | second_fpn.pyÂ +Â <br><br>fpn_jittor.py                            | âœ… å·²å®Œæˆ |
| **VFE (ä½“ç´ ç‰¹å¾ç¼–ç )**                | CUDA C++ Voxelization          | dynamic_pillar_vfe.pyÂ (351è¡Œ)                                     | âœ… å·²å®Œæˆ |
| **Pillar Encoder**              | pillar_encoder.py              | pillar_encoder.py                                                | âœ… å·²å®Œæˆ |
| **BEV Encoder**                 | radar_guided_bev_encoder.py    | åŒå (369è¡Œ)                                                        | âœ… å·²å®Œæˆ |
| **BEV Attention**               | radar_guided_bev_attention.py  | åŒå (436è¡Œ)                                                        | âœ… å·²å®Œæˆ |
| **Spatial Cross Attention**     | spatial_cross_attention.py     | åŒå (447è¡Œ)                                                        | âœ… å·²å®Œæˆ |
| **Deformable Attention ç®—å­**     | CUDAÂ `MSDeformAttnFunction`    | multi_scale_deformable_attn_function.pyÂ (çº¯Python,Â `grid_sample`) | âœ… å·²å®Œæˆ |
| **Decoder**                     | decoder.py                     | åŒå (414è¡Œ)                                                        | âœ… å·²å®Œæˆ |
| **Transformer (Main)**          | transformer_radar.py           | åŒå (390è¡Œ)                                                        | âœ… å·²å®Œæˆ |
| **Feature Level Fusion Head**   | feature_level_fusion.py        | åŒå (686è¡Œ)                                                        | âœ… å·²å®Œæˆ |
| **Instance Level Fusion**       | instance_level_fusion.py       | instance_level_fusion_jittor.pyÂ (536è¡Œ)                           | âœ… å·²å®Œæˆ |
| **åæ ‡å˜æ¢**                        | coord_transform.py             | coord_transform_jittor.py                                        | âœ… å·²å®Œæˆ |
| **Detr3D Cross Attention**      | detr3d_cross_attention.py      | detr3d_cross_attention_jittor.py                                 | âœ… å·²å®Œæˆ |
| **PointNet æ¨¡å—**                 | CUDA ops                       | pointnet_utils_jittor.pyÂ (çº¯Python)                               | âœ… å·²å®Œæˆ |
| **æ£€æµ‹å™¨ä¸»ç±»**                       | rcm_fusion.py                  | rcm_fusion_jittor.pyÂ (508è¡Œ)                                      | âœ… å·²å®Œæˆ |
| **ä¸¤é˜¶æ®µæ£€æµ‹å™¨åŸºç±»**                    | mvx_two_stage_custom.py        | mvx_two_stage_custom_jittor.py                                   | âœ… å·²å®Œæˆ |
| **æŸå¤±å‡½æ•°**                        | mmdet3d å†…ç½®                     | SigmoidFocalLoss,Â <br><br>L1LossÂ (åœ¨ head ä¸­)                      | âœ… å·²å®Œæˆ |
| **BBox Coder/Assigner/Sampler** | mmdet3d                        | `core/bbox/`Â ç›®å½• (22ä¸ªå­é¡¹)                                          | âœ… å·²å®Œæˆ |
| **Radar Camera Gating**         | åŒå                             | åŒå                                                               | âœ… å·²å®Œæˆ |

### 3. æ•°æ®ç®¡é“ (Data Pipeline)

| æ¨¡å—                                         | æ–‡ä»¶                                       | çŠ¶æ€                  |
| ------------------------------------------ | ---------------------------------------- | ------------------- |
| **NuScenes æ•°æ®é›†**                           | jittor_custom_nuscenes_dataset.pyÂ (393è¡Œ) | âœ… å·²å®Œæˆ               |
| **æ•°æ®é¢„å¤„ç†ç®¡çº¿**                                | jittor_pipelines.pyÂ (353è¡Œ)               | âœ… å·²å®Œæˆ               |
| **<br><br>LoadMultiViewImageFromFiles**    | åŒä¸Š                                       | âœ… å·²å®Œæˆ               |
| **<br><br>LoadRadarPointsFromMultiSweeps** | åŒä¸Š                                       | âœ… å·²å®Œæˆ               |
| **<br><br>LoadAnnotations3D**              | åŒä¸Š                                       | âœ… å·²å®Œæˆ               |
| **<br><br>DefaultFormatBundle3D**          | åŒä¸Š                                       | âœ… å·²å®Œæˆ               |
| **<br><br>Collect3D**                      | åŒä¸Š                                       | âœ… å·²å®Œæˆ               |
| **<br><br>RadarPointCloud**                | åŒä¸Š (PCD æ–‡ä»¶è§£æ)                            | âœ… å·²å®Œæˆ               |
| **<br><br>collate_batch**                  | Dataset å†…ç½®                               | âœ… å·²å®Œæˆ               |
| **NuScenes è¯„ä¼°**                            | nuscnes_eval.pyÂ (752è¡Œ)                   | âš ï¸ éƒ¨åˆ†å®Œæˆ (ä»ä¾èµ– torch) |

### 4. éªŒè¯ä¸æµ‹è¯•

| å†…å®¹                                        | çŠ¶æ€                                                               |
| ----------------------------------------- | ---------------------------------------------------------------- |
| **æ¨¡å‹å‰å‘ä¼ æ’­ (æ¨¡æ‹Ÿæ•°æ®)**                         | âœ…Â `verify_model_forward.py`Â å·²é€šè¿‡                                  |
| **é›†æˆæµ‹è¯• (Backboneâ†’Neckâ†’Headâ†’Transformer)** | âœ…Â `test_head_integration.py`Â å·²é€šè¿‡                                 |
| **å„ç»„ä»¶å•å…ƒæµ‹è¯•**                               | âœ… å¤šä¸ªæµ‹è¯•æ–‡ä»¶ (`test_fusion.py`,Â `test_backbone.py`,Â `test_vfe.py`Â ç­‰) |
| **é…ç½®æ–‡ä»¶**                                  | âœ…Â `projects/configs/rcmfusion_icra/`Â ä¿ç•™                          |
| **é¢„è®­ç»ƒæƒé‡è½¬æ¢**                               | âœ…Â `rcm_fusion_r50_jittor.pkl`Â (253MB)                            |

### 5. å·²è§£å†³çš„å…³é”®æŠ€æœ¯é—®é¢˜

- âœ…Â **SpConv â†’ Dense Conv**: ä½¿ç”¨Â `jt.nn.Conv2d`Â å®Œå…¨æ›¿ä»£äº† 3D ç¨€ç–å·ç§¯

- âœ…Â **CUDA Deformable Attention â†’ grid_sample**: çº¯ Python å®ç°

- âœ…Â **CUDA Voxelization â†’ NumPy/Jittor**: çº¯ Python ä½“ç´ åŒ–

- âœ…Â **CUDA PointNet Ops â†’ çº¯ Python**:Â `ball_query`,Â `furthest_point_sample`Â ç­‰

- âœ…Â **batch_first ç»´åº¦ä¸åŒ¹é…**: ä¿®å¤äº† BEV Attention ä¸­çš„ permute/å¹¿æ’­ bug

- âœ…Â **æ•°å€¼ç¨³å®šæ€§**: ä¿®å¤äº†Â 
  
  inverse_sigmoidÂ çš„ NaN/Inf é—®é¢˜

- âœ…Â **mmcv ä¾èµ–è„±è€¦**: ç”¨Â 
  
  jittor_adapter.pyÂ æ›¿ä»£äº†æ•´ä¸ª MM ç³»åˆ—åº“

---

## âŒ æœªå®Œæˆçš„å†…å®¹

### 1. è®­ç»ƒæµç¨‹ ğŸ”´ (æ ¸å¿ƒç¼ºå¤±)

| æ¨¡å—                                | é—®é¢˜                                                                                                 |
| --------------------------------- | -------------------------------------------------------------------------------------------------- |
| **<br><br>train.py**Â (apis)       | âŒ ä»ä½¿ç”¨Â `from mmseg.apis import train_segmentor`Â å’ŒÂ `from mmdet.apis import train_detector`ï¼Œ**å®Œå…¨æœªè¿ç§»** |
| **<br><br>epoch_based_runner.py** | âŒ ä»ç›´æ¥Â `import torch`,Â `import mmcv`ï¼Œç»§æ‰¿Â <br><br>EpochBasedRunnerï¼Œ**å®Œå…¨æœªè¿ç§»**                          |
| **<br><br>mmdet_train.py**Â (apis) | âŒ ä»ä¾èµ– mmcv/mmdetï¼Œ**æœªè¿ç§»**                                                                           |
| **Jittor åŸç”Ÿè®­ç»ƒè„šæœ¬**                 | âŒÂ **ä¸å­˜åœ¨**Â `train_jittor.py`ï¼Œéœ€è¦ä»é›¶ç¼–å†™ä¸€ä¸ªè„±ç¦» mmcv.runner çš„è®­ç»ƒå¾ªç¯                                           |
| **Jittor ä¼˜åŒ–å™¨é›†æˆ**                  | âŒ æœªé›†æˆÂ `jt.optim.AdamW`Â å’ŒÂ `jt.lr_scheduler`                                                         |

### 2. æµ‹è¯•/è¯„ä¼°æµç¨‹ ğŸŸ¡ (éƒ¨åˆ†ç¼ºå¤±)

| æ¨¡å—                          | é—®é¢˜                                                                                |
| --------------------------- | --------------------------------------------------------------------------------- |
| **<br><br>test.py**Â (apis)  | âŒ ä»ä½¿ç”¨Â `import torch`,Â `import mmcv`ï¼Œ`torch.no_grad()`ï¼Œ`DataContainer`Â ç­‰ï¼Œ**å®Œå…¨æœªè¿ç§»** |
| **<br><br>nuscnes_eval.py** | âš ï¸ ä»æœ‰Â `import torch`Â ä¾èµ– (752è¡Œ)ï¼Œéƒ¨åˆ†åŠŸèƒ½å¯èƒ½ä¸å—å½±å“ (NuScenes è¯„ä¼°ä¸»è¦æ˜¯ numpy è®¡ç®—)               |
| **<br><br>eval_hooks.py**   | âŒ æœªè¿ç§» (3524å­—èŠ‚)ï¼Œä¾èµ– mmcv                                                            |
| **è¯„ä¼°æŒ‡æ ‡ (mAP/NDS)**          | âš ï¸ è¯„ä¼°é€»è¾‘éƒ¨åˆ†å°±ç»ª (NuScenes devkit)ï¼Œä½†ä¸æ¨¡å‹è¾“å‡ºçš„å¯¹æ¥æœªå®Œå…¨éªŒè¯                                      |

### 3. æ•°æ®ç®¡é“é—ç•™é—®é¢˜ ğŸŸ¡

| æ¨¡å—                     | é—®é¢˜                                                                |
| ---------------------- | ----------------------------------------------------------------- |
| **åŸå§‹ Dataset æ–‡ä»¶**      | nuscenes_dataset.pyã€<br><br>nuscenes_dataset_new.pyÂ ç­‰å¤šä¸ªå†å²ç‰ˆæœ¬å…±å­˜ï¼Œæœªæ¸…ç† |
| **åŸå§‹ Pipeline**        | `pipelines/`Â ç›®å½•ä¸‹çš„æ–‡ä»¶å¯èƒ½ä»ä¾èµ– PyTorch                                  |
| **<br><br>builder.py** | æ•°æ®é›†æ„å»ºå™¨å¯èƒ½æœ‰æœªè¿ç§»çš„é€»è¾‘                                                   |
| **Sampler**            | `samplers/`Â ç›®å½• (4ä¸ªæ–‡ä»¶) æœªç¡®è®¤è¿ç§»çŠ¶æ€                                     |
| **çœŸå®æ•°æ®éªŒè¯**             | âš ï¸ è™½ç„¶ Pipeline å·²å†™å¥½ï¼Œä½†å®Œæ•´çš„ NuScenesÂ `v1.0-mini`Â ç«¯åˆ°ç«¯æ•°æ®åŠ è½½â†’æ¨¡å‹æ¨ç†çš„éªŒè¯æœªæ˜ç¡®é€šè¿‡ |

### 4. å·¥å…·å’Œè¾…åŠ©æ¨¡å— ğŸŸ¡

| æ¨¡å—                                | é—®é¢˜                                        |
| --------------------------------- | ----------------------------------------- |
| **<br><br>tools/train.py**        | âŒ åŸå§‹ mmdet3d è®­ç»ƒå…¥å£ï¼Œæœªè¿ç§» (9968å­—èŠ‚)            |
| **<br><br>tools/test.py**         | âŒ åŸå§‹ mmdet3d æµ‹è¯•å…¥å£ï¼Œæœªè¿ç§» (10347å­—èŠ‚)           |
| **<br><br>hooks/custom_hooks.py** | âŒæœªç¡®è®¤                                      |
| **æ•°æ®è½¬æ¢å·¥å…·**                        | `tools/data_converter/`Â ä¸‹ 13 ä¸ªæ–‡ä»¶ï¼Œå¯èƒ½éƒ¨åˆ†éœ€è¦è¿ç§» |

---

## ğŸ“Š æ•´ä½“è¿ç§»è¿›åº¦è¯„ä¼°

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”

â”‚         ç±»åˆ«                â”‚  å®Œæˆåº¦   â”‚   è¯´æ˜     â”‚

â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤

â”‚ åŸºç¡€è®¾æ–½ (Adapter/Registry) â”‚  95%     â”‚ åŸºæœ¬å®Œæˆ    â”‚

â”‚ æ¨¡å‹æ ¸å¿ƒç»„ä»¶               â”‚  95%     â”‚ å…¨é¢å®Œæˆ    â”‚

â”‚ æ•°æ®ç®¡é“                   â”‚  80%     â”‚ æ ¸å¿ƒå®Œæˆ,ç»†èŠ‚å¾…éªŒ  â”‚

â”‚ è®­ç»ƒæµç¨‹                   â”‚  10%     â”‚ å‡ ä¹æœªå¼€å§‹   â”‚

â”‚ æµ‹è¯•/è¯„ä¼°æµç¨‹              â”‚  30%     â”‚ éœ€è¦é‡å†™    â”‚

â”‚ å·¥å…·é“¾                     â”‚  20%     â”‚ éœ€è¦é‡å†™å…¥å£ â”‚

â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤

â”‚ **æ€»ä½“è¿›åº¦**               â”‚ **~65%** â”‚           â”‚

â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

---

## ğŸ¯ ä¸‹ä¸€æ­¥ä¼˜å…ˆäº‹é¡¹

1. **ğŸ”´ [æœ€é«˜ä¼˜å…ˆçº§] ç¼–å†™Â `train_jittor.py`**
   
   - è„±ç¦»Â `mmcv.runner`ï¼Œå†™ä¸€ä¸ªç®€å•çš„Â `for epoch / for batch`Â è®­ç»ƒå¾ªç¯
   - é›†æˆÂ `jt.optim.AdamW`Â +Â `jt.lr_scheduler`
   - åœ¨Â `v1.0-mini`Â æ•°æ®é›†ä¸ŠéªŒè¯è®­ç»ƒèƒ½è·‘é€š

2. **ğŸ”´ [æœ€é«˜ä¼˜å…ˆçº§] ç¼–å†™Â `test_jittor.py`**
   
   - è„±ç¦» PyTorch çš„æ¨ç†å…¥å£
   - ç”¨Â `jt.no_grad()`Â æ›¿æ¢Â `torch.no_grad()`
   - å¯¹æ¥ NuScenes è¯„ä¼° (JSON è¾“å‡º â†’Â `nuscenes-devkit`)

3. **ğŸŸ¡ [æ¬¡ä¼˜å…ˆçº§] çœŸå®æ•°æ®ç«¯åˆ°ç«¯éªŒè¯**
   
   - ç¡®è®¤Â 
     
     JittorCustomNuScenesDatasetÂ åœ¨çœŸå® NuScenes æ•°æ®ä¸Šæ­£å¸¸å·¥ä½œ
   
   - éªŒè¯å®Œæ•´é“¾è·¯: Data â†’ VFE â†’ Backbone â†’ Neck â†’ Transformer â†’ Head â†’ Output

4. **ğŸŸ¡ æ¸…ç†æ—§æ–‡ä»¶**
   
   - ç§»é™¤ä»ä¾èµ– torch/mmcv çš„æ—§ç‰ˆæ–‡ä»¶ (
     
     train.py,Â 
     
     test.py,Â 
     
     epoch_based_runner.pyÂ ç­‰)
   
   - æ•´ç†å¤šä¸ªé‡å¤çš„ dataset å®ç°

**æ€»ç»“**: è¯¥é¡¹ç›®**æœ€å›°éš¾çš„åº•å±‚æ¨¡å‹è¿ç§»å·¥ä½œå·²ç»å®Œæˆ**ï¼ˆæ‰€æœ‰ CUDA ç®—å­æ›¿æ¢ã€ç¨€ç–å·ç§¯å¯†é›†åŒ–ã€MM ç³»åˆ—åº“è„±è€¦ï¼‰ï¼Œä¸»è¦çš„å‰©ä½™å·¥ä½œé›†ä¸­åœ¨**è®­ç»ƒå’Œè¯„ä¼°æµç¨‹**çš„å·¥ç¨‹åŒ–å±‚é¢ã€‚æŠ€æœ¯é£é™©è¾ƒä½ï¼Œä½†å·¥ç¨‹é‡ä¸­ç­‰ã€‚
